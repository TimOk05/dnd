<?php
session_start();

// --- –ó–∞–º–µ—Ç–∫–∏ ---
if (!isset($_SESSION['notes'])) {
    $_SESSION['notes'] = [];
}
if (isset($_POST['add_note']) && isset($_POST['note_content'])) {
    $_SESSION['notes'][] = trim($_POST['note_content']);
    exit('OK');
}
if (isset($_POST['remove_note'])) {
    $idx = (int)$_POST['remove_note'];
    if (isset($_SESSION['notes'][$idx])) {
        array_splice($_SESSION['notes'], $idx, 1);
    }
    exit('OK');
}

// --- –ë—ã—Å—Ç—Ä—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ AJAX ---
if (isset($_POST['fast_action'])) {
    $action = $_POST['fast_action'];
    $apiKey = 'sk-1e898ddba737411e948af435d767e893';
    $apiUrl = 'https://api.deepseek.com/v1/chat/completions';
    $systemInstruction = '–í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è, –±–µ–∑ markdown, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –∑–≤—ë–∑–¥–æ—á–µ–∫. –†–∞–∑–¥–µ–ª—è–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç NPC –Ω–∞ —Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏: –û–ø–∏—Å–∞–Ω–∏–µ, –í–Ω–µ—à–Ω–æ—Å—Ç—å, –ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è, –ö–æ—Ä–æ—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞. –í –±–ª–æ–∫–µ –ö–æ—Ä–æ—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –≤—ã–≤–µ–¥–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏: –û—Ä—É–∂–∏–µ, –£—Ä–æ–Ω, –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, –•–∏—Ç—ã. –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –Ω–∞—á–∏–Ω–∞–π —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞.';

    // --- –ö–æ—Å—Ç–∏ ---
    if ($action === 'dice_result') {
        $dice = $_POST['dice'] ?? '1d20';
        $label = $_POST['label'] ?? '';
        if (preg_match('/^(\d{1,2})d(\d{1,3})$/', $dice, $m)) {
            $count = (int)$m[1]; $sides = (int)$m[2];
            $results = [];
            for ($i = 0; $i < $count; $i++) $results[] = rand(1, $sides);
            $sum = array_sum($results);
            $out = "–ë—Ä–æ—Å–æ–∫: $dice\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: " . implode(', ', $results) . "\n–°—É–º–º–∞: $sum";
            if ($label) $out .= "\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: $label";
            echo nl2br(htmlspecialchars($out));
            exit;
        } else {
            echo '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫—É–±–æ–≤!';
            exit;
        }
    }

    // --- NPC ---
    if ($action === 'npc_result') {
        $race = $_POST['race'] ?? '';
        $class = $_POST['class'] ?? '';
        $prof = $_POST['prof'] ?? '';
        $level = $_POST['level'] ?? '1';
        $prompt = "–°–æ–∑–¥–∞–π NPC –¥–ª—è DnD. –†–∞—Å–∞: $race. –ö–ª–∞—Å—Å: $class. –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: $prof. –£—Ä–æ–≤–µ–Ω—å: $level. –î–æ–±–∞–≤—å –∏–º—è. $systemInstruction";
        $data = [
            'model' => 'deepseek-chat',
            'messages' => [
                ['role' => 'system', 'content' => $systemInstruction],
                ['role' => 'user', 'content' => $prompt]
            ]
        ];
        $ch = curl_init($apiUrl);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            'Content-Type: application/json',
            'Authorization: Bearer ' . $apiKey
        ]);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        $response = curl_exec($ch);
        $curlError = curl_error($ch);
        curl_close($ch);
        $result = json_decode($response, true);
        $aiMessage = $result['choices'][0]['message']['content'] ?? '';
        if (!$aiMessage) {
            echo '<div class="result-segment"><b>DEBUG:</b><br><pre>' . htmlspecialchars("CURL ERROR: $curlError\nRESPONSE: $response") . '</pre></div>';
            exit;
        }
        $aiMessage = preg_replace('/[*_`>#\-]+/', '', $aiMessage);
        $aiMessage = str_replace(['"', "'", '‚Äú', '‚Äù', '¬´', '¬ª'], '', $aiMessage);
        $aiMessage = preg_replace('/\n{2,}/', "\n", $aiMessage);
        $aiMessage = preg_replace('/\s{3,}/', "\n", $aiMessage);
        $lines = explode("\n", $aiMessage);
        $formatted = [];
        foreach ($lines as $line) {
            $line = trim($line);
            if (mb_strlen($line) > 90) {
                $formatted = array_merge($formatted, str_split($line, 80));
            } else {
                $formatted[] = $line;
            }
        }
        $aiMessage = implode("<br>", $formatted);
        echo $aiMessage;
        exit;
    }
    echo '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ';
    exit;
}

// --- –ß–∞—Ç ---
if (!isset($_SESSION['chat'])) {
    $_SESSION['chat'] = [];
}
if (isset($_GET['reset'])) {
    $_SESSION['chat'] = [];
    header("Location: index.php");
    exit;
}
$systemInstruction = '–í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è, –±–µ–∑ markdown, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –∑–≤—ë–∑–¥–æ—á–µ–∫. –†–∞–∑–±–∏–≤–∞–π —Ç–µ–∫—Å—Ç –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã.';
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['message']) && !isset($_POST['add_note']) && !isset($_POST['remove_note'])) {
    $userMessage = trim($_POST['message']);
    if ($userMessage !== '') {
        if (empty($_SESSION['chat']) || $_SESSION['chat'][0]['role'] !== 'system') {
            array_unshift($_SESSION['chat'], ['role' => 'system', 'content' => $systemInstruction]);
        }
        $_SESSION['chat'][] = ['role' => 'user', 'content' => $userMessage];
        $apiKey = 'sk-1e898ddba737411e948af435d767e893';
        $apiUrl = 'https://api.deepseek.com/v1/chat/completions';
        $messages = array_map(function($msg) {
            return ['role' => $msg['role'], 'content' => $msg['content']];
        }, $_SESSION['chat']);
        $data = [
            'model' => 'deepseek-chat',
            'messages' => $messages
        ];
        $ch = curl_init($apiUrl);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            'Content-Type: application/json',
            'Authorization: Bearer ' . $apiKey
        ]);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        $response = curl_exec($ch);
        curl_close($ch);
        $result = json_decode($response, true);
        $aiMessage = $result['choices'][0]['message']['content'] ?? '[–û—à–∏–±–∫–∞ AI]';
        $aiMessage = preg_replace('/[*_`>#\-]+/', '', $aiMessage);
        $aiMessage = str_replace(['"', "'", '‚Äú', '‚Äù', '¬´', '¬ª'], '', $aiMessage);
        $aiMessage = preg_replace('/\n{2,}/', "\n", $aiMessage);
        $aiMessage = preg_replace('/\s{3,}/', "\n", $aiMessage);
        $lines = explode("\n", $aiMessage);
        $formatted = [];
        foreach ($lines as $line) {
            $line = trim($line);
            if (mb_strlen($line) > 90) {
                $formatted = array_merge($formatted, str_split($line, 80));
            } else {
                $formatted[] = $line;
            }
        }
        $aiMessage = implode("\n", $formatted);
        $_SESSION['chat'][] = ['role' => 'assistant', 'content' => $aiMessage];
    }
}

// --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ ---
$fastBtns = '';
$fastBtns .= '<button class="fast-btn" onclick="openDiceStep1()">üé≤ –ë—Ä–æ—Å–æ–∫ –∫–æ—Å—Ç–µ–π</button>';
$fastBtns .= '<button class="fast-btn" onclick="openNpcStep1()">üó£Ô∏è NPC</button>';

// --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º system) ---
$chatMsgs = '';
foreach ($_SESSION['chat'] as $msg) {
    if ($msg['role'] === 'system') continue;
    $who = $msg['role'] === 'user' ? '–í—ã' : 'AI';
    $class = $msg['role'];
    $chatMsgs .= '<div class="msg ' . $class . '"><b>' . $who . ':</b> ' . nl2br(htmlspecialchars($msg['content'])) . '</div>';
}

// --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞ –∑–∞–º–µ—Ç–æ–∫ ---
$notesBlock = '';
foreach ($_SESSION['notes'] as $i => $note) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∏–∑ HTML (strip_tags, explode –ø–æ <br> –∏–ª–∏ \n)
    $plain = strip_tags(str_replace(['<br>', "\n"], "\n", $note));
    $firstLine = explode("\n", $plain)[0];
    $notesBlock .= '<div class="note-item" onclick="expandNote(' . $i . ')">' . htmlspecialchars($firstLine, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8') . '<button class="note-remove" onclick="event.stopPropagation();removeNote(' . $i . ')">√ó</button></div>';
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ –∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ---
$template = file_get_contents(__DIR__ . '/template.html');
$template = str_replace('{{fast_buttons}}', $fastBtns, $template);
$template = str_replace('{{chat_messages}}', $chatMsgs, $template);
$template = str_replace('{{notes_block}}', $notesBlock, $template);
echo $template;
?>
<script>
// --- Dice Modal Steps ---
function openDiceStep1() {
    showModal('<b class="mini-menu-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ—Å—Ç–∏:</b><div class="mini-menu-btns">' +
        ['d3','d4','d6','d8','d10','d12','d20','d100'].map(d => `<button onclick=\'openDiceStep2("${d}")\' class=\'fast-btn\'>${d}</button>`).join(' ') + '</div>'
    );
    document.getElementById('modal-save').style.display = 'none';
}
function openDiceStep2(dice) {
    showModal(`<b class="mini-menu-title">–°–∫–æ–ª—å–∫–æ –±—Ä–æ—Å–∫–æ–≤ ${dice}?</b><div class="npc-level-wrap"><input type=number id=dice-count value=1 min=1 max=20 style=\'width:60px\'></div><div class="npc-level-wrap"><input type=text id=dice-label placeholder=\'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)\' style=\'margin-top:8px;width:90%\'></div><button class=\'fast-btn\' onclick=\'getDiceResult("${dice}")\'>–ë—Ä–æ—Å–∏—Ç—å</button>`);
    document.getElementById('modal-save').style.display = 'none';
}
function getDiceResult(dice) {
    let count = document.getElementById('dice-count').value;
    let label = document.getElementById('dice-label').value;
    let diceStr = count + dice;
    fetch('', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'fast_action=dice_result&dice=' + encodeURIComponent(diceStr) + '&label=' + encodeURIComponent(label)
    })
    .then(r => r.text())
    .then(txt => {
        document.getElementById('modal-content').innerHTML = formatResultSegments(txt, false);
        document.getElementById('modal-save').style.display = '';
        document.getElementById('modal-save').onclick = function() { saveNote(txt); closeModal(); };
    });
}
// --- NPC Modal Steps ---
const npcRaces = ['–ß–µ–ª–æ–≤–µ–∫','–≠–ª—å—Ñ','–ì–Ω–æ–º','–ü–æ–ª—É–æ—Ä–∫','–ü–æ–ª—É—Ä–æ—Å–ª–∏–∫','–¢–∏—Ñ–ª–∏–Ω–≥','–î—Ä–∞–∫–æ–Ω–æ—Ä–æ–∂–¥–µ–Ω–Ω—ã–π','–ü–æ–ª—É—ç–ª—å—Ñ','–î–≤–æ—Ä—Ñ','–ì–æ–±–ª–∏–Ω','–û—Ä–∫','–ö–æ–±–æ–ª—å–¥','–Ø—â–µ—Ä–æ–ª—é–¥','–ì–æ–±–ª–∏–Ω','–ì–Ω–æ–º','–•–æ–±–±–∏—Ç'];
const npcClasses = ['–ë–µ–∑ –∫–ª–∞—Å—Å–∞','–í–æ–∏–Ω','–ü–∞–ª–∞–¥–∏–Ω','–ö–æ–ª–¥—É–Ω','–ú–∞–≥','–†–∞–∑–±–æ–π–Ω–∏–∫','–°–ª–µ–¥–æ–ø—ã—Ç','–ñ—Ä–µ—Ü','–ë–∞—Ä–¥','–í–∞—Ä–≤–∞—Ä','–ü–ª—É—Ç','–ú–æ–Ω–∞—Ö','–ß–∞—Ä–æ–¥–µ–π','–î—Ä—É–∏–¥'];
const npcProfs = ['–ü—Ä–æ—Ö–æ–∂–∏–π','–°—Ç—Ä–∞–∂–Ω–∏–∫','–¢–∞–≤–µ—Ä–Ω—â–∏–∫','–¢–æ—Ä–≥–æ–≤–µ—Ü','–ö—É–∑–Ω–µ—Ü','–ù–∞—ë–º–Ω–∏–∫','–ñ—Ä–µ—Ü','–ü—Ä–µ—Å—Ç—É–ø–Ω–∏–∫','–†–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫','–û—Ö–æ—Ç–Ω–∏–∫','–ü–æ–≤–∞—Ä','–ü–∏—Å–∞—Ä—å','–ú–∞—Å—Ç–µ—Ä –≥–∏–ª—å–¥–∏–∏','–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫','–ú—É–¥—Ä–µ—Ü'];
let npcRace = '', npcClass = '', npcProf = '', npcLevel = 1;
function openNpcStep1() {
    showModal('<b class="mini-menu-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É NPC:</b><div class="mini-menu-btns">' + npcRaces.map(r => `<button onclick=\'openNpcStep2("${r}")\' class=\'fast-btn\'>${r}</button>`).join(' ') + '</div>');
    document.getElementById('modal-save').style.display = 'none';
}
function openNpcStep2(race) {
    npcRace = race;
    showModal('<b class="mini-menu-title">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å NPC:</b><div class="mini-menu-btns">' + npcClasses.map(c => `<button onclick=\'openNpcStepLevel("${c}")\' class=\'fast-btn\'>${c}</button>`).join(' ') + '</div>');
    document.getElementById('modal-save').style.display = 'none';
}
function openNpcStepLevel(cls) {
    npcClass = cls;
    showModal('<b class="mini-menu-title">–£–∫–∞–∂–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å NPC (1-20):</b><div class="npc-level-wrap"><input type=number id=npc-level value=1 min=1 max=20 style=\'width:60px\'></div><button class=\'fast-btn\' onclick=\'openNpcStep3WithLevel()\'>–î–∞–ª–µ–µ</button>');
    document.getElementById('modal-save').style.display = 'none';
}
function openNpcStep3WithLevel() {
    npcLevel = document.getElementById('npc-level').value;
    showModal('<b class="mini-menu-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é NPC:</b><div class="mini-menu-btns">' + npcProfs.map(p => `<button onclick=\'getNpcResult("${p}")\' class=\'fast-btn\'>${p}</button>`).join(' ') + '</div>');
    document.getElementById('modal-save').style.display = 'none';
}
function getNpcResult(prof) {
    npcProf = prof;
    showModal('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è NPC...');
    fetch('', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'fast_action=npc_result&race=' + encodeURIComponent(npcRace) + '&class=' + encodeURIComponent(npcClass) + '&prof=' + encodeURIComponent(npcProf) + '&level=' + encodeURIComponent(npcLevel)
    })
    .then(r => r.text())
    .then(txt => {
        document.getElementById('modal-content').innerHTML = formatNpcBlocks(txt);
        document.getElementById('modal-save').style.display = '';
        document.getElementById('modal-save').onclick = function() { saveNote(txt); closeModal(); };
    });
}
// --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ NPC –ø–æ —Å–º—ã—Å–ª–æ–≤—ã–º –±–ª–æ–∫–∞–º ---
function formatNpcBlocks(txt) {
    // –ë–ª–æ–∫–∏: –û–ø–∏—Å–∞–Ω–∏–µ, –í–Ω–µ—à–Ω–æ—Å—Ç—å, –ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è, –ö–æ—Ä–æ—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞
    const blockTitles = [
        '–û–ø–∏—Å–∞–Ω–∏–µ', '–í–Ω–µ—à–Ω–æ—Å—Ç—å', '–ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞', '–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è', '–ö–æ—Ä–æ—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞'
    ];
    let blocks = [];
    let current = null;
    let lines = txt.split(/<br>|\n/).map(l => l.trim());
    for (let line of lines) {
        if (!line) continue;
        let found = blockTitles.find(t => line.toLowerCase().startsWith(t.toLowerCase() + ':'));
        if (found) {
            if (current) blocks.push(current);
            current = {title: found, content: line.slice(found.length+1).trim()};
        } else if (current) {
            current.content += (current.content ? '<br>' : '') + line;
        }
    }
    if (current) blocks.push(current);
    let out = '';
    for (let block of blocks) {
        if (block.title === '–ö–æ—Ä–æ—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞') {
            out += `<div class="npc-summary"><b>${block.title}:</b><br>${block.content}</div>`;
        } else {
            out += `<div class="result-segment"><b>${block.title}:</b> ${block.content}</div>`;
        }
    }
    return out;
}
// --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±—Ä–æ—Å–∫–æ–≤ ---
function formatResultSegments(txt, isNpc) {
    if (isNpc) {
        return formatNpcBlocks(txt);
    } else {
        // –î–ª—è –±—Ä–æ—Å–∫–æ–≤: –±—Ä–æ—Å–æ–∫+—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Å—É–º–º–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
        const lines = txt.split(/<br>|\n/).map(l => l.trim()).filter(Boolean);
        let out = '';
        if (lines.length) {
            out += `<div class="result-segment">${lines[0]}</div>`;
        }
        if (lines.length > 1) {
            out += `<div class="result-segment-alt">${lines[1]}</div>`;
        }
        if (lines.length > 2) {
            out += `<div class="result-segment">${lines.slice(2).join('<br>')}</div>`;
        }
        return out;
    }
}
// --- Modal & Notes ---
function showModal(content) {
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('modal-bg').classList.add('active');
}
function closeModal() {
    document.getElementById('modal-bg').classList.remove('active');
}
document.getElementById('modal-close').onclick = closeModal;
document.getElementById('modal-bg').onclick = function(e) { if (e.target === this) closeModal(); };
function saveNote(content) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    var content = document.getElementById('modal-content').innerHTML;
    fetch('', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'add_note=1&note_content=' + encodeURIComponent(content)
    }).then(() => location.reload());
}
function removeNote(idx) {
    fetch('', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'remove_note=' + encodeURIComponent(idx)
    }).then(() => location.reload());
}
function expandNote(idx) {
    if (window.allNotes && window.allNotes[idx]) {
        var content = window.allNotes[idx];
        if (content && content.trim()) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-bg').classList.add('active');
            document.getElementById('modal-save').style.display = 'none';
        }
    }
}
// –ü–µ—Ä–µ–¥–∞—ë–º –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏ –≤ JS
window.allNotes = <?php echo json_encode($_SESSION['notes'], JSON_UNESCAPED_UNICODE); ?>;
</script>
